#!/bin/bash
set -e

# Configuration
POLL_INTERVAL_SECONDS=30
TIMEOUT_SECONDS=900 # 15 minutes

function cleanup() {
  echo "Cleaning up..."
  git fetch -p -P
  git remote prune origin
  git gc
}

trap cleanup EXIT

function show_help() {
  echo "Usage: $(basename "$0") [options]"
  echo "Options:"
  echo "  --timeout <seconds>    Timeout for waiting for a pull request to be merged (default: 900)."
  echo "  --poll-interval <seconds>  Interval for polling the pull request status (default: 30)."
  echo "  --help                   Show this help message."
}

# Parse command-line arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    --timeout)
      TIMEOUT_SECONDS="$2"
      shift 2
      ;;
    --poll-interval)
      POLL_INTERVAL_SECONDS="$2"
      shift 2
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "Invalid option: $1" >&2
      show_help
      exit 1
      ;;
  esac
done

# Check for gh CLI
if ! command -v gh &> /dev/null; then
  echo "Error: gh CLI is not installed. Please install it to use this script."
  exit 1
fi

# Check for gh auth status
if ! gh auth status &> /dev/null; then
  echo "Error: Not logged in to GitHub. Please run 'gh auth login'."
  exit 1
fi

MAIN_BRANCH=$(gh repo view --json defaultBranchRef.name -q .defaultBranchRef.name)
if [[ -z "$MAIN_BRANCH" ]]; then
  echo "Error: Could not determine the default branch for this repository."
  exit 1
fi
echo "Using main branch: $MAIN_BRANCH"

# Get the list of pull requests from the user
echo "Enter the pull request branches in the order they should be merged (one per line)."
echo "Press Enter on an empty line to finish."

BRANCHES=()
while read -r line && [[ -n "$line" ]]; do
  BRANCHES+=("$line")
done

git fetch --all --prune

# Loop through the pull requests and process them
for BRANCH in "${BRANCHES[@]}"; do
  echo "Processing pull request branch: $BRANCH"
  git checkout "$BRANCH"
  git rebase "$MAIN_BRANCH"
  git push --force-with-lease

  PR_URL=$(gh pr view --json url -q .url)
  if [[ -z "$PR_URL" ]]; then
    echo "Error: Could not get pull request URL for branch '$BRANCH'."
    exit 1
  fi

  echo "Waiting for pull request $PR_URL to be merged..."
  START_TIME=$(date +%s)
  while true; do
    STATE=$(gh pr view "$PR_URL" --json state -q .state)
    if [[ "$STATE" == "MERGED" ]]; then
      echo "Pull request $PR_URL has been merged."
      break
    fi

    ELAPSED_TIME=$(( $(date +%s) - START_TIME ))
    if (( ELAPSED_TIME > TIMEOUT_SECONDS )); then
      echo "Error: Timeout waiting for pull request $PR_URL to be merged."
      exit 1
    fi

    sleep "$POLL_INTERVAL_SECONDS"
  done

  git checkout "$MAIN_BRANCH"
  git pull
  git branch -D "$BRANCH"
  echo "Branch '$BRANCH' has been deleted."
done

echo "All pull requests have been processed."
